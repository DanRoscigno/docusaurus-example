(window.webpackJsonp=window.webpackJsonp||[]).push([[23],{107:function(e,t,n){"use strict";n.d(t,"a",(function(){return p})),n.d(t,"b",(function(){return h}));var a=n(0),r=n.n(a);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=r.a.createContext({}),u=function(e){var t=r.a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},p=function(e){var t=u(e.components);return r.a.createElement(l.Provider,{value:t},e.children)},b={inlineCode:"code",wrapper:function(e){var t=e.children;return r.a.createElement(r.a.Fragment,{},t)}},d=r.a.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,i=e.parentName,l=c(e,["components","mdxType","originalType","parentName"]),p=u(n),d=a,h=p["".concat(i,".").concat(d)]||p[d]||b[d]||o;return n?r.a.createElement(h,s(s({ref:t},l),{},{components:n})):r.a.createElement(h,s({ref:t},l))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,i=new Array(o);i[0]=d;var s={};for(var c in t)hasOwnProperty.call(t,c)&&(s[c]=t[c]);s.originalType=e,s.mdxType="string"==typeof e?e:a,i[1]=s;for(var l=2;l<o;l++)i[l]=n[l];return r.a.createElement.apply(null,i)}return r.a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},168:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/diagramme-a3129a89146da039e92f876863db303a.png"},169:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/api-settings1-39375c21f8b253f07dea81190a4a3e73.png"},170:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/api-settings2-14e2906dff84dec5245eed4db4abe4f7.png"},171:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/key_vault-02ede9dacfe2112fbf2c23f600ca3f65.png"},172:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/key_vault2-a0aaa66ef19633079cf3651dabf87c5e.png"},173:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/http-func-62612a741ffe79f21662cd25830fbf6a.png"},174:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/blob_output-73db3fbf30f74d52966814d8ec0522c9.png"},175:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/json_example-e7c94cc60b974a0b1ad342d9efde298a.png"},92:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return i})),n.d(t,"metadata",(function(){return s})),n.d(t,"toc",(function(){return c})),n.d(t,"default",(function(){return u}));var a=n(3),r=n(7),o=(n(0),n(107)),i={title:"Data Engineering Project - Azure APIM, Azure Functions, Blob Storage - Part 3",author:"Kristijan Bakaric",author_title:"Mr.",author_url:"https://www.linkedin.com/in/kristijanb/",author_image_url:"https://media-exp1.licdn.com/dms/image/C4E03AQF-5oI5fHJPjw/profile-displayphoto-shrink_800_800/0/1606336983715?e=1620259200&v=beta&t=VvBP6s8IMDUwKDfvj6B3c-gGmN3IfioALIAboXg_DGE",tags:["dataengineering","projects","azure","python"],hide_table_of_contents:!1},s={permalink:"/personal-website/blog/2021/04/06/data-engineering-part3",source:"@site/blog/2021-04-6-data-engineering-part3.md",description:"In this post, I will create the first part of the data streaming pipeline which consists of API gateway that will accept API calls and route them to the Azure Function, which will further process the data and (initially) store them to Azure Blob Storage.",date:"2021-04-06T00:00:00.000Z",tags:[{label:"dataengineering",permalink:"/personal-website/blog/tags/dataengineering"},{label:"projects",permalink:"/personal-website/blog/tags/projects"},{label:"azure",permalink:"/personal-website/blog/tags/azure"},{label:"python",permalink:"/personal-website/blog/tags/python"}],title:"Data Engineering Project - Azure APIM, Azure Functions, Blob Storage - Part 3",readingTime:6.055,truncated:!0,nextItem:{title:"Data Engineering Project - Pre-process data - Part 2",permalink:"/personal-website/blog/2021/03/06/data-engineering-part2"}},c=[{value:"Introduction",id:"introduction",children:[]},{value:"Step 2 - (or step 0 actually) - Azure Function(s)",id:"step-2---or-step-0-actually---azure-functions",children:[]},{value:"Step 3 - Write messages to Azure Blob Storage",id:"step-3---write-messages-to-azure-blob-storage",children:[]},{value:"In the Next Post...",id:"in-the-next-post",children:[]}],l={toc:c};function u(e){var t=e.components,i=Object(r.a)(e,["components"]);return Object(o.b)("wrapper",Object(a.a)({},l,i,{components:t,mdxType:"MDXLayout"}),Object(o.b)("p",null,Object(o.b)("img",{parentName:"p",src:"https://images.unsplash.com/photo-1518289646039-3e6c87a5aaf6?ixid=MXwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHw%3D&ixlib=rb-1.2.1&auto=format&fit=crop&w=2102&q=80",alt:null})),Object(o.b)("blockquote",null,Object(o.b)("p",{parentName:"blockquote"},"In this post, I will create the first part of the data streaming pipeline which consists of API gateway that will accept API calls and route them to the Azure Function, which will further process the data and (initially) store them to Azure Blob Storage.")),Object(o.b)("h2",{id:"introduction"},"Introduction"),Object(o.b)("p",null,"Now that we have the data in the desired format and with the relevant content, we can embark in the world of Azure where we will start selecting a suite of services which will assist us in reaching our goal, and that is to build a streaming data pipeline."),Object(o.b)("p",null,"As sketched on the diagramme below, in this post I will create and describe following three Azure services:"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},Object(o.b)("p",{parentName:"li"},Object(o.b)("a",{parentName:"p",href:"https://docs.microsoft.com/en-us/azure/api-management/api-management-key-concepts"},"Azure API Management"))),Object(o.b)("li",{parentName:"ul"},Object(o.b)("p",{parentName:"li"},Object(o.b)("a",{parentName:"p",href:"https://docs.microsoft.com/en-us/azure/azure-functions/functions-overview"},"Azure Functions"))),Object(o.b)("li",{parentName:"ul"},Object(o.b)("p",{parentName:"li"},Object(o.b)("a",{parentName:"p",href:"https://docs.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction"},"Azure Blob Storage")," "))),Object(o.b)("p",null,Object(o.b)("img",{src:n(168).default}),"\nFigure 1: Diagramme of the data preparation process."),Object(o.b)("h1",{id:"step-1---azure-api-management"},"Step 1 - Azure API Management"),Object(o.b)("p",null,"As explained in the official Microsoft's docs, API Management (APIM) is a way to create consistent and modern API gateways for existing back-end services."),Object(o.b)("p",null,"I created an API gateway that:"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},"had a single API endpoint which would accept API calls"),Object(o.b)("li",{parentName:"ul"},"API would reference to the back-end Function App which I previously had to already create, in order for it to be accessible when I add an API in APIM"),Object(o.b)("li",{parentName:"ul"},"single POST operation that represents an operation that maps to the operation mapped to the operation implemented in the backend Function App service that was written in Python.")),Object(o.b)("p",null,"Settings in the API were configured as following:"),Object(o.b)("p",null,Object(o.b)("img",{src:n(169).default})),Object(o.b)("p",null,Object(o.b)("img",{src:n(170).default})),Object(o.b)("p",null,"What is important to notice that ",Object(o.b)("inlineCode",{parentName:"p"},"Subscription Required")," is toggled on.\nWhen you publish APIs through API Management, it's easy and common to secure access to those APIs by using subscription keys, which I immediately did leave as it was defaulted, with subscription required."),Object(o.b)("p",null,"In order to consume the published API, I now have to include a valid subscription key in HTTP requests header when I make calls to the created API. Otherwise, the calls are rejected immediately by the API Management gateway. They aren't forwarded to the back-end services."),Object(o.b)("p",null,"In addition to the to subscription key required I wanted to check out and test Policies which are a powerful capability of the Azure API Management (APIM) that allows the publisher to change the behavior of the API through configuration. APIM policy is a collection of statements executed sequentially on the request or response of an API. We can define our policy statement in four configuration sections: inbound, backend, outbound, and on-error. It is nicely explained here by ",Object(o.b)("a",{parentName:"p",href:"https://aztoso.com/posts/apim-basic-auth-keyvault/"},"Aleksandar Stefanov in his post"),". He also suggests to store the user details in a Key Vault secret."),Object(o.b)("p",null,"As he wrote in the post, although we can think of the Basic authentication as a legacy, there are still companies who are using this authentication mechanism, mostly because of its simplicity and legacy software base. "),Object(o.b)("p",null,"The following is the overview of the steps I did to enable a Basic Authentication policy together with the other necessary steps required:"),Object(o.b)("p",null,"1) Enabled managed identity for API management.\n2) Created a Key Vault in Azure.\n",Object(o.b)("img",{src:n(171).default}),"\n3) Enabled access to the key vault secrets from API management.\n4) Added demoUserName and demoUserPassword as keys, and values as actual username and passwords.\n5) Create a Named value in the API Management with the Key Vault URL, password and username\n",Object(o.b)("img",{src:n(172).default}),"\n6) In the inbound part of your policy definition, add the following code:"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre"},'    ```\n    <policies>\n        <inbound>\n            <base />\n            <choose>\n                <when condition="@(context.Request.Headers.     GetValueOrDefault("Authorization").AsBasic().UserId!="{     {username}}" || context.Request.Headers.GetValueOrDefault  ("Authorization").AsBasic().Password!="{{password}}")">\n                    <return-response>\n                        <set-status code="401" reason="Not authorized" />\n                    </return-response>\n                </when>\n            </choose>\n            <set-header name="Authorization" exists-action="delete" />\n        </inbound>\n        <backend>\n            <base />\n        </backend>\n        <outbound>\n            <base />\n        </outbound>\n        <on-error>\n            <base />\n        </on-error>\n    </policies>\n    ```  \n')),Object(o.b)("p",null,"7) Tested with a request containing following header (it was within the Test API part of the APIM on Azure portal so Ocp-Apim-Subscription-Key: \u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022 was added automatically if toggled on): "),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre"},"`Authorization Basic <Base64 representation of the combination username:password>`\n")),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},"HTTP triggered Azure function was execured succesfully with a 200 OK status.")),Object(o.b)("p",null,"Now that I have a double secure way of consuming, created API, lets rewind a bit, and go to a prerequisite and that is, Azure Function that that will act as a backend and have binding s to Azure Blob Storage and Azure Events Hub."),Object(o.b)("h2",{id:"step-2---or-step-0-actually---azure-functions"},"Step 2 - (or step 0 actually) - Azure Function(s)"),Object(o.b)("p",null,"Azure Function App consists of two Azure Functions as a part of an Azure streaming data pipeline"),Object(o.b)("p",null,"1) Azure Function in our case are acting as a backend in Azure API management, and they consume POST json tweet messages, checks validity and conformity to a predefined json schema, and if ok, it passes the data onwards to Azure Event Hub (and writes to Azure Blob Storage)."),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre"},"`./HttpTriggerTweetToBlobAndEventHub`\n")),Object(o.b)("p",null,Object(o.b)("img",{src:n(173).default}),"   "),Object(o.b)("p",null,"I will not go into details of development environment (Locally developed on WSL2 with Ubuntu 20.04 via VisualStudio Code and its plugins for Azure Services), and code itself since it is anyway very simple."),Object(o.b)("p",null,"Function will have two validation steps:"),Object(o.b)("p",null,"1) Check in Pyton code if invalid json was passed, if so raise an exception with an appropriate message and status code to the sender client:"),Object(o.b)("p",null,"2) Check if the actual json object in the body of a POST reqest is conforming to the defined json schema."),Object(o.b)("p",null,"This is the schema that input POST request body needs to conform to:"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre"},'tweet_schema = {\n    # "$schema": "http://json-schema.org/draft-04/schema#",\n    "type": "object",\n    "properties": {\n        "tweet_id": {\n            "type": "integer"\n        },\n        "account_id": {\n            "type": "integer"\n        },\n        "likes": {\n            "type": "integer"\n        },\n        "replies": {\n            "type": "integer"\n        },\n        "retweets": {\n            "type": "integer"\n        },\n        "tweet": {\n            "type": "string"\n        },\n        "time": {\n            "type": "integer"\n        },\n        "tear_month_date": {\n            "type": "string"\n        },\n        "damage_flag": {\n            "type": "string"\n        },\n        "image_base64": {\n            "type": "string"\n        },\n        "latitude": {\n            "type": "number"\n        },\n        "longitude": {\n            "type": "number"\n        }\n    },\n    "required": [\n        "tweet_id",\n        "account_id",\n        "likes",\n        "replies",\n        "retweets",\n        "tweet",\n        "time",\n        "tear_month_date",\n        "damage_flag",\n        "image_base64",\n        "latitude",\n        "longitude"\n    ]\n}\n')),Object(o.b)("h2",{id:"step-3---write-messages-to-azure-blob-storage"},"Step 3 - Write messages to Azure Blob Storage"),Object(o.b)("p",null,"If incoming json message  via HTTP POST request was accepted to created API endpoint, and if Azure Function validated the body of the tweet message sucesfully I decided to first test out the binding towards the Azure Blob Storage."),Object(o.b)("p",null,"From Azure Function bindings definition:"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre"},'   {\n      "type": "blob",\n      "direction": "out",\n      "name": "outputBlob",\n      "path": "output/{rand-guid}.json",\n      "connection": "AzureWebJobsStorage"\n    },\n')),Object(o.b)("p",null,"We see that after sucesfully sending a bunch of tweets to API endpoint and thus to azure function, all messages were sucesfully written as json files iwth a rand-guid id as filename."),Object(o.b)("p",null,Object(o.b)("img",{src:n(174).default}),"  "),Object(o.b)("p",null,"This is the content of one example tweet opened directly in blob storage:"),Object(o.b)("p",null,Object(o.b)("img",{src:n(175).default}),"  "),Object(o.b)("h2",{id:"in-the-next-post"},"In the Next Post..."),Object(o.b)("p",null,"We have a secure functioning API endpoint that accepts valid and well defined tweet messages sent as HTTP POST requests, and it is sucesfully being written to azure blob storage as json files."),Object(o.b)("p",null,"In the next post, I will introduce and create following Azure Services:"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},Object(o.b)("p",{parentName:"li"},Object(o.b)("a",{parentName:"p",href:"https://docs.microsoft.com/en-us/azure/event-hubs/event-hubs-about"},"Azure Event Hubs"))),Object(o.b)("li",{parentName:"ul"},Object(o.b)("p",{parentName:"li"},Object(o.b)("a",{parentName:"p",href:"https://docs.microsoft.com/en-us/azure/cosmos-db/introduction"},"Azure Cosmos DB")," - SQL Core - Document Store"))),Object(o.b)("p",null,"Main goal will be to work Azure Event Hubs as a big data streaming platform and event ingestion service which can receive and process millions of events per second, and also to store the messages into a - Azure Cosmos DB's, SQL Core - Document Store, which purpose is to act as a fully managed NoSQL database. "))}u.isMDXComponent=!0}}]);