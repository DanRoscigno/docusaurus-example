(window.webpackJsonp=window.webpackJsonp||[]).push([[16],{111:function(e,t,n){"use strict";n.d(t,"a",(function(){return b})),n.d(t,"b",(function(){return h}));var a=n(0),i=n.n(a);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=i.a.createContext({}),u=function(e){var t=i.a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},b=function(e){var t=u(e.components);return i.a.createElement(l.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return i.a.createElement(i.a.Fragment,{},t)}},d=i.a.forwardRef((function(e,t){var n=e.components,a=e.mdxType,r=e.originalType,o=e.parentName,l=c(e,["components","mdxType","originalType","parentName"]),b=u(n),d=a,h=b["".concat(o,".").concat(d)]||b[d]||p[d]||r;return n?i.a.createElement(h,s(s({ref:t},l),{},{components:n})):i.a.createElement(h,s({ref:t},l))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var r=n.length,o=new Array(r);o[0]=d;var s={};for(var c in t)hasOwnProperty.call(t,c)&&(s[c]=t[c]);s.originalType=e,s.mdxType="string"==typeof e?e:a,o[1]=s;for(var l=2;l<r;l++)o[l]=n[l];return i.a.createElement.apply(null,o)}return i.a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},169:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/diagramme-a3129a89146da039e92f876863db303a.png"},170:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/api-settings1-39375c21f8b253f07dea81190a4a3e73.png"},171:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/api-settings2-14e2906dff84dec5245eed4db4abe4f7.png"},172:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/key_vault-02ede9dacfe2112fbf2c23f600ca3f65.png"},173:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/key_vault2-a0aaa66ef19633079cf3651dabf87c5e.png"},174:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/http-func-62612a741ffe79f21662cd25830fbf6a.png"},175:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/blob_output-73db3fbf30f74d52966814d8ec0522c9.png"},176:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/json_example-e7c94cc60b974a0b1ad342d9efde298a.png"},84:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return o})),n.d(t,"metadata",(function(){return s})),n.d(t,"toc",(function(){return c})),n.d(t,"default",(function(){return u}));var a=n(3),i=n(7),r=(n(0),n(111)),o={title:"Data Engineering Project - Azure APIM, Azure Functions, Blob Storage - Part 3",author:"Kristijan Bakaric",author_title:"Mr.",author_url:"https://www.linkedin.com/in/kristijanb/",author_image_url:"https://media-exp1.licdn.com/dms/image/C4E03AQF-5oI5fHJPjw/profile-displayphoto-shrink_800_800/0/1606336983715?e=1620259200&v=beta&t=VvBP6s8IMDUwKDfvj6B3c-gGmN3IfioALIAboXg_DGE",tags:["dataengineering","projects","azure","python","api"],hide_table_of_contents:!1},s={permalink:"/personal-website/blog/2021/03/07/data-engineering-part3",source:"@site/blog/2021-03-07-data-engineering-part3.md",description:"In this post, I will explain how I created the first part of the data streaming pipeline which has an API gateway that will accept API calls (with tweet messages) and route them to the Azure Function, that further processes the data and (initially) store them to Azure Blob Storage.",date:"2021-03-07T00:00:00.000Z",tags:[{label:"dataengineering",permalink:"/personal-website/blog/tags/dataengineering"},{label:"projects",permalink:"/personal-website/blog/tags/projects"},{label:"azure",permalink:"/personal-website/blog/tags/azure"},{label:"python",permalink:"/personal-website/blog/tags/python"},{label:"api",permalink:"/personal-website/blog/tags/api"}],title:"Data Engineering Project - Azure APIM, Azure Functions, Blob Storage - Part 3",readingTime:6.53,truncated:!0,prevItem:{title:"Data Engineering Project - Azure Event Hubs, Function and Cosmos DB - Part 4",permalink:"/personal-website/blog/2021/03/08/data-engineering-part4"},nextItem:{title:"Data Engineering Project - Pre-process data - Part 2",permalink:"/personal-website/blog/2021/03/06/data-engineering-part2"}},c=[{value:"Introduction",id:"introduction",children:[]},{value:"Step 2 - (or step 0 actually) - Azure Function(s)",id:"step-2---or-step-0-actually---azure-functions",children:[]},{value:"Step 3 - Write messages to Azure Blob Storage",id:"step-3---write-messages-to-azure-blob-storage",children:[]},{value:"In the Next Post...",id:"in-the-next-post",children:[]}],l={toc:c};function u(e){var t=e.components,o=Object(i.a)(e,["components"]);return Object(r.b)("wrapper",Object(a.a)({},l,o,{components:t,mdxType:"MDXLayout"}),Object(r.b)("p",null,Object(r.b)("img",{parentName:"p",src:"https://images.unsplash.com/photo-1518289646039-3e6c87a5aaf6?ixid=MXwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHw%3D&ixlib=rb-1.2.1&auto=format&fit=crop&w=2102&q=80",alt:null})),Object(r.b)("blockquote",null,Object(r.b)("p",{parentName:"blockquote"},"In this post, I will explain how I created the first part of the data streaming pipeline which has an API gateway that will accept API calls (with tweet messages) and route them to the Azure Function, that further processes the data and (initially) store them to Azure Blob Storage.")),Object(r.b)("h2",{id:"introduction"},"Introduction"),Object(r.b)("p",null,"Now that we have the data in the desired format and with the relevant content, we can embark in the world of Azure where we will select a suite of services that will assist us in reaching our goal, and that is to build a data streaming pipeline."),Object(r.b)("p",null,"In this blog post I touch upon following Azure services (see also the diagram below):"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},Object(r.b)("p",{parentName:"li"},Object(r.b)("a",{parentName:"p",href:"https://docs.microsoft.com/en-us/azure/api-management/api-management-key-concepts"},"Azure API Management"))),Object(r.b)("li",{parentName:"ul"},Object(r.b)("p",{parentName:"li"},Object(r.b)("a",{parentName:"p",href:"https://docs.microsoft.com/en-us/azure/azure-functions/functions-overview"},"Azure Functions"))),Object(r.b)("li",{parentName:"ul"},Object(r.b)("p",{parentName:"li"},Object(r.b)("a",{parentName:"p",href:"https://docs.microsoft.com/en-us/azure/key-vault/general/overview"},"Azure Key Vault")," ")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("p",{parentName:"li"},Object(r.b)("a",{parentName:"p",href:"https://docs.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction"},"Azure Blob Storage")," "))),Object(r.b)("p",null,Object(r.b)("img",{src:n(169).default}),"\nFigure 1: Diagramme of the data preparation process."),Object(r.b)("h1",{id:"step-1---azure-api-management"},"Step 1 - Azure API Management"),Object(r.b)("p",null,"As explained in the official Microsoft's docs, API Management (APIM) is a way to create consistent and modern API gateways for existing back-end services."),Object(r.b)("p",null,"My API gateway in APIM:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"had a single API endpoint that would accept API calls (requests with tweet messages)"),Object(r.b)("li",{parentName:"ul"},"API references to the back-end Function App which I previously already  had to create, for it to be accessible when I add an API in APIM"),Object(r.b)("li",{parentName:"ul"},"single POST operation mapped to the operation implemented in the backend Function App service that was written in Python.")),Object(r.b)("p",null,"Settings in the API were configured as follows:"),Object(r.b)("p",null,Object(r.b)("img",{src:n(170).default})),Object(r.b)("p",null,Object(r.b)("img",{src:n(171).default})),Object(r.b)("p",null,"What is important to notice that ",Object(r.b)("inlineCode",{parentName:"p"},"Subscription Required")," is toggled on.\nWhen you publish APIs through API Management, it's easy and common to secure access to those APIs by using subscription keys, which I immediately did leave as it was by default - with subscription required."),Object(r.b)("p",null,"To consume the published API, I now have to include a valid subscription key in the HTTP requests header when I make calls to the created API. Otherwise, the calls are rejected immediately by the API Management gateway. They aren't forwarded to the back-end services."),Object(r.b)("p",null,"In addition to the subscription key required, I wanted to check out and test Policies which are a powerful capability of the Azure API Management (APIM) that allows the publisher to change the behaviour of the API through configuration. APIM policy is a collection of statements executed sequentially on the request or response of an API. We can define our policy statement in four configuration sections: inbound, backend, outbound, and on-error. It is nicely explained here by "),Object(r.b)("p",null,"As he wrote in the post, although we can think of Basic authentication as a legacy, there are still companies who are using this authentication mechanism, mostly because of its simplicity and legacy software base. "),Object(r.b)("p",null,"The following is the overview of the steps I did to enable a Basic Authentication policy together with all necessary steps:"),Object(r.b)("p",null,"1) Enabled managed identity for API management.\n2) Created a Key Vault in Azure.\n",Object(r.b)("img",{src:n(172).default}),"\n3) Enabled access to the key vault secrets from API management.\n4) Added demoUserName and demoUserPassword as keys, and values as actual username and passwords.\n5) Create a Named value in the API Management with the Key Vault URL, password and username.\n",Object(r.b)("img",{src:n(173).default}),"\n6) In the inbound part of your Policy definition, added the following code:"),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre"},'    ```\n    <policies>\n        <inbound>\n            <base />\n            <choose>\n                <when condition="@(context.Request.Headers.     GetValueOrDefault("Authorization").AsBasic().UserId!="{     {username}}" || context.Request.Headers.GetValueOrDefault  ("Authorization").AsBasic().Password!="{{password}}")">\n                    <return-response>\n                        <set-status code="401" reason="Not authorized" />\n                    </return-response>\n                </when>\n            </choose>\n            <set-header name="Authorization" exists-action="delete" />\n        </inbound>\n        <backend>\n            <base />\n        </backend>\n        <outbound>\n            <base />\n        </outbound>\n        <on-error>\n            <base />\n        </on-error>\n    </policies>\n    ```  \n')),Object(r.b)("p",null,"7) Tested with a request containing the following header (it was within the Test API part of the APIM on Azure portal so Ocp-Apim-Subscription-Key: \u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022 was added automatically if toggled on in the settings): "),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre"},"`Authorization Basic <Base64 representation of the combination username:password>`\n")),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"HTTP triggered Azure function was executed successfully with a 200 OK status.")),Object(r.b)("p",null,"Now that I have a double secure way of consuming created API, let us rewind a bit, and go to a prerequisite and that is creating an Azure Function that will act as a backend and have bindings to Azure Blob Storage and Azure Events Hub."),Object(r.b)("h2",{id:"step-2---or-step-0-actually---azure-functions"},"Step 2 - (or step 0 actually) - Azure Function(s)"),Object(r.b)("p",null,"Azure Function App consists of two Azure Functions as a part of an Azure streaming data pipeline:"),Object(r.b)("p",null,"1) Azure Function in our case is acting as a backend in Azure API management and is consuming POST requests with tweet messages. In the function logic, it checks for validity and conformity of the JSON messages to a predefined JSON schema, and if valid, it passes the JSON onwards to Azure Event Hubs and writes them to Azure Blob Storage as JSON files."),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre"},"`./HttpTriggerTweetToBlobAndEventHub`\n")),Object(r.b)("p",null,Object(r.b)("img",{src:n(174).default}),"   "),Object(r.b)("p",null,"I will not go into details of the development environment (Locally developed on WSL2 with Ubuntu 20.04 via Visual Studio Code and its plugins for Azure Services), and Python code itself since it is anyway very simple."),Object(r.b)("p",null,"The function has two validation steps:"),Object(r.b)("p",null,"1) Python logic to check if valid JSON was sent via HTTP request, if invalid, it raises an exception with an appropriate message and status code to the sender client."),Object(r.b)("p",null,"2) Check if the JSON message is conforming to the predefined JSON schema:"),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre"},'tweet_schema = {\n    # "$schema": "http://json-schema.org/draft-04/schema#",\n    "type": "object",\n    "properties": {\n        "tweet_id": {\n            "type": "integer"\n        },\n        "account_id": {\n            "type": "integer"\n        },\n        "likes": {\n            "type": "integer"\n        },\n        "replies": {\n            "type": "integer"\n        },\n        "retweets": {\n            "type": "integer"\n        },\n        "tweet": {\n            "type": "string"\n        },\n        "time": {\n            "type": "integer"\n        },\n        "tear_month_date": {\n            "type": "string"\n        },\n        "damage_flag": {\n            "type": "string"\n        },\n        "image_base64": {\n            "type": "string"\n        },\n        "latitude": {\n            "type": "number"\n        },\n        "longitude": {\n            "type": "number"\n        }\n    },\n    "required": [\n        "tweet_id",\n        "account_id",\n        "likes",\n        "replies",\n        "retweets",\n        "tweet",\n        "time",\n        "tear_month_date",\n        "damage_flag",\n        "image_base64",\n        "latitude",\n        "longitude"\n    ]\n}\n')),Object(r.b)("h2",{id:"step-3---write-messages-to-azure-blob-storage"},"Step 3 - Write messages to Azure Blob Storage"),Object(r.b)("p",null,"If an incoming JSON  request was accepted by API in Azure APIM, and if Azure Function validated the body of the tweet message successfully I decided to initially test writing successful messages with the Azure Function bindings towards the Azure Blob Storage."),Object(r.b)("p",null,"For the ones that are not familiar with the binding in Azure Functions, ","[binding]","(Binding to a function is a way of declaratively connecting another resource to the function; bindings may be connected as input bindings, output bindings, or both. Data from bindings is provided to the function as parameters.) to a function is a way of declaratively connecting another resource to the function; bindings may be connected as input bindings, output bindings, or both. Data from bindings are provided to the function as parameters."),Object(r.b)("p",null,"This is how my binding is defined in the Azure Function bindings definition:"),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre"},'   {\n      "type": "blob",\n      "direction": "out",\n      "name": "outputBlob",\n      "path": "output/{rand-guid}.json",\n      "connection": "AzureWebJobsStorage"\n    },\n')),Object(r.b)("p",null,"It is obvious that after successfully sending an x number of HTTP requests with tweets to an API endpoint, and thus to Azure function backend, all messages were successfully written as JSON files with a rand-guid id as the filename."),Object(r.b)("p",null,Object(r.b)("img",{src:n(175).default}),"  "),Object(r.b)("p",null,"This is the content of one example tweet opened directly in blob storage:"),Object(r.b)("p",null,Object(r.b)("img",{src:n(176).default})," "),Object(r.b)("h2",{id:"in-the-next-post"},"In the Next Post..."),Object(r.b)("p",null,"We now have a secure functioning API endpoint that accepts valid and well-defined tweet messages sent as HTTP POST requests, and the body of requests are successfully being written to Azure blob storage as JSON files."),Object(r.b)("p",null,"In the next post, I will introduce and create the following Azure Services:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},Object(r.b)("p",{parentName:"li"},Object(r.b)("a",{parentName:"p",href:"https://docs.microsoft.com/en-us/azure/event-hubs/event-hubs-about"},"Azure Event Hubs"))),Object(r.b)("li",{parentName:"ul"},Object(r.b)("p",{parentName:"li"},Object(r.b)("a",{parentName:"p",href:"https://docs.microsoft.com/en-us/azure/cosmos-db/introduction"},"Azure Cosmos DB")," - SQL Core - Document Store"))),Object(r.b)("p",null,"The main goal will be to have Azure Event Hubs as a big data streaming platform and event ingestion service which can receive and process millions of events per second (not our case but it has the possibility), and also store the messages into Azure Cosmos DB's, a SQL Core - Document Store, which purpose is to act as a fully managed NoSQL database. "))}u.isMDXComponent=!0}}]);